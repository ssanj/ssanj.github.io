<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>BabylonCandle</title>
        <link>http://blog.ssanj.net</link>
        <description><![CDATA[The blog of Sanjiv Sahayam]]></description>
        <atom:link href="http://blog.ssanj.net/feed.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Tue, 11 Jun 2019 00:00:00 UT</lastBuildDate>
        <item>
    <title>Running Scala Metals With Sublime Text on MacOSX</title>
    <link>http://blog.ssanj.net/posts/2019-06-11-running-scala-metals-with-sublime-text-on-macosx.html</link>
    <description><![CDATA[<p>I’ve finally got <a href="https://scalameta.org/metals">Scala Metals</a> working through Sublime Text 3 on MacOSX Mojave and I’m pretty happy about it! There are some quirks to getting it to work though, so I thought I’d document them here for anyone else who might be struggling to set this up.</p>
<div class="figure">
<img src="/images/metals/metals-sample.gif" alt="Metal Works" />
<p class="caption">Metal Works</p>
</div>
<h2 id="installation">Installation</h2>
<ul>
<li>Use the package manager to install the <em>LSP</em> plugin from <a href="https://packagecontrol.io/packages/LSP">tomv564/LSP</a> or from <a href="https://github.com/tomv564/LSP">Github</a>.</li>
<li>Make sure you have a Java 8 JDK installed and that it is returned as the default JDK. You can find out what your default JDK is by running:</li>
</ul>
<pre class="terminal scrollx"><code>  /usr/libexec/java-home</code></pre>
<p>If you don’t see a JDK 1.8.x version listed, then have a look at <a href="#invalid-java-version-something-other-than-jdk-8">Invalid Java Version</a></p>
<ul>
<li>Make sure you have a supported Scala version (2.11 and 2.12):</li>
</ul>
<blockquote>
<p>Metals works only with Scala versions 2.12.8, 2.12.7, 2.11.12, 2.12.6, 2.12.5, 2.12.4, 2.11.11, 2.11.10 and 2.11.9. Note that 2.10.x and 2.13.x are not supported.</p>
</blockquote>
<ul>
<li>Install <a href="https://get-coursier.io/">coursier</a> through <em>Homebrew</em>:</li>
</ul>
<pre class="terminal scrollx"><code>  brew tap coursier/formulas
  brew install coursier</code></pre>
<p>Once installed verify that you have the latest version with:</p>
<pre class="terminal scrollx"><code>  coursier --help</code></pre>
<p>Which should return you a version after <code>1.1.0-M9</code>. The latest version as of writing this post is:</p>
<pre class="terminal scrollx"><code>  Coursier 2.0.0-RC1</code></pre>
<ul>
<li>Install <a href="https://scalameta.org/metals/">Scala Metals</a> for <a href="https://scalameta.org/metals/docs/editors/sublime.html">Sublime Text</a>:</li>
</ul>
<pre class="terminal scrollx"><code>  coursier bootstrap \
    --java-opt -Xss4m \
    --java-opt -Xms100m \
    --java-opt -Dmetals.client=sublime \
    org.scalameta:metals_2.12:0.6.1 \
    -r bintray:scalacenter/releases \
    -r sonatype:snapshots \
    -o /usr/local/bin/metals-sublime -f</code></pre>
<p><em>The incantation above installs Metals <code>0.6.1</code>. Check the Metals site for the latest version</em>.</p>
<p>Ensure the generated <strong>metals-sublime</strong> binary is available on your <em>$PATH</em>.</p>
<ul>
<li>Ensure you have <a href="https://www.scala-sbt.org/">SBT</a> version 0.13.17+ or 1.x installed.</li>
</ul>
<h2 id="configuration">Configuration</h2>
<ul>
<li>Update your <em>key bindings</em> for LSP (<strong>Preferences</strong> &gt; <strong>Package Settings</strong> &gt; <strong>LSP</strong> &gt; <strong>Key Bindings</strong>) as needed. The snippet below adds the <strong>F12</strong> binding for going to a definition of a symbol and the <strong>CMD</strong> + <strong>ALT</strong> + <strong>H</strong> binding for signature help and <strong>SHIFT</strong> + <strong>F10</strong> to import a project:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode json scrollx"><code class="sourceCode json">    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;f12&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_symbol_definition&quot;</span><span class="fu">}</span><span class="er">,</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;super+alt+h&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;noop&quot;</span><span class="fu">,</span> <span class="dt">&quot;context&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp.signature_help&quot;</span><span class="fu">,</span> <span class="dt">&quot;operator&quot;</span><span class="fu">:</span> <span class="st">&quot;equal&quot;</span><span class="fu">,</span> <span class="dt">&quot;operand&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span> <span class="fu">}</span><span class="er">,</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;shift+f10&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_execute&quot;</span><span class="fu">,</span> <span class="dt">&quot;args&quot;</span><span class="fu">:{</span><span class="dt">&quot;command_name&quot;</span><span class="fu">:</span> <span class="st">&quot;build-import&quot;</span><span class="fu">,</span> <span class="dt">&quot;command_args&quot;</span><span class="fu">:{}}}</span><span class="er">,</span></code></pre></div>
<ul>
<li>Update your <em>settings</em> for LSP (<strong>Preferences</strong> &gt; <strong>Package Settings</strong> &gt; <strong>LSP</strong> &gt; <strong>Settings</strong>) with the following:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode json scrollx"><code class="sourceCode json"><span class="fu">{</span>
  <span class="dt">&quot;log_payloads&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;log_debug&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;log_stderr&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;show_diagnostics_severity_level&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span>
  <span class="dt">&quot;show_code_actions_bulb&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;complete_all_chars&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;only_show_lsp_completions&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
  <span class="dt">&quot;prefer_label_over_filter_text&quot;</span><span class="fu">:</span> <span class="kw">true</span>
<span class="fu">}</span></code></pre></div>
<p>I’ve included a lot of diagnostic logging to ensure I can see when something goes wrong. If you are happy with your setup, feel free to remove this extra logging:</p>
<ul>
<li><strong>log_payloads</strong> - Log all payloads from the LSP server</li>
<li><strong>log_debug</strong> - Extra verbose logging</li>
<li><strong>log_stderr</strong> - Log server errors</li>
<li><strong>show_diagnostics_severity_level</strong> - Bumped to 4 which is INFO and below (everything). 3 is default.</li>
</ul>
<p>These are the non-diagnostic settings:</p>
<ul>
<li><strong>prefer_label_over_filter_text</strong> - Set to <strong>true</strong> to return full function definitions as suggestions. If set to <strong>false</strong> returns only the function name.</li>
<li><strong>show_code_actions_bulb</strong> - Show icon in the gutter when there is an action to take</li>
<li><strong>only_show_lsp_completions</strong> - When set to <strong>true</strong> Turns off all other suggestions for completions.</li>
<li><strong>complete_all_chars</strong> - Set to <strong>true</strong> to get completions for all characters</li>
</ul>
<p>You can find more detail on these settings in the <a href="https://lsp.readthedocs.io/en/latest/features/#configuring">docs</a>.</p>
<ul>
<li>Open a Scala project through Sublime Text.</li>
<li>Launch the Command Palette with <strong>CMD</strong> + <strong>SHIFT</strong> + <strong>P</strong> and choose <strong>LSP: Enable Language Server in Project</strong> &gt; <strong>metals</strong>. This will create a <em>.metals</em> directory in your root folder. It will contain a <em>metals.log</em> file which you can scan for any errors.</li>
<li>Open the console with <strong>CTRL</strong> + <strong>`</strong> to scan for any errors.</li>
<li>Browse to a Scala file and open it. This needs to be done to trigger the import process.</li>
<li><p>There should be a prompt asking you to import the project. Choose <strong>import</strong>. This will then proceed to download all your dependencies and create a <em>.bloop</em> directory in your root folder. You should see something like this in the console:</p>
<blockquote>
<p>server: running ‘sbt metalsEnable bloopInstall’</p>
</blockquote></li>
<li><p>Watch the console for any obvious errors such as:</p>
<blockquote>
<p>no functionality will work</p>
</blockquote></li>
<li><p>If everything worked you should see something like this in the logs:</p>
<blockquote>
<p>server: time: compiled project your_project_name in time_taken s</p>
</blockquote></li>
<li><p>If you didn’t see the import dialog, press <strong>SHIFT</strong> + <strong>F10</strong>. If you saw any errors in the log go to <a href="#workarounds">workarounds</a>.</p></li>
</ul>
<h2 id="workarounds">Workarounds</h2>
<h3 id="no-import-dialog">No Import Dialog</h3>
<ul>
<li>Try <strong>SHIFT</strong> + <strong>F10</strong>. If that does not work follow the steps below.</li>
<li>Launch the Command Palette with <strong>CMD</strong> + <strong>SHIFT</strong> + <strong>P</strong> and choose <strong>LSP: Disable Language Server in Project</strong> &gt; <strong>metals</strong>.</li>
<li>Delete the <em>.metals</em> directory. If you haven’t stopped the server, the <em>.metals</em> folder will keep reappearing.</li>
<li>Close the project window. You may see a message about the metals server crashing. Choose <strong>cancel</strong> not to restart it.</li>
<li><p>Open your project in Sublime Text again.</p></li>
<li>Launch the Command Palette with <strong>CMD</strong> + <strong>SHIFT</strong> + <strong>P</strong> and choose <strong>LSP: Enable Language Server in Project</strong> &gt; <strong>metals</strong>.</li>
<li>Open a Scala file.</li>
<li><p>You should now see the <strong>import</strong> dialog. Choose <strong>import</strong>.</p></li>
</ul>
<p><em>If you do not see the <em>import</em> dialog check the logs for one of the other errors listed below.</em></p>
<h3 id="invalid-sbt-version">Invalid SBT version</h3>
<p>You’ll see something like this in the Sublime Text console:</p>
<blockquote>
<p>Automatic build import is not supported for sbt 0.13.xyz. To fix this problem, upgrade to sbt v0.13.17+</p>
</blockquote>
<p>Bump your SBT version to at least <em>0.13.17</em> in your <em>project/properties</em> and then follow <a href="#no-import-dialog">No Import Dialog</a></p>
<h3 id="invalid-java-version-something-other-than-jdk-8">Invalid Java version (Something other than JDK 8)</h3>
<p>Metals only works with JDK 8 at the moment.</p>
<blockquote>
<p>OpenJDK or Oracle Java 8. Eclipse OpenJ9 and Java 11 are not supported, please make sure the JAVA_HOME environment variable points to valid Java 8 installation.</p>
</blockquote>
<p>Use <em>/usr/libexec/java-home</em> to verify your JDK version. When I initially ran it, I had a bunch of JDKs installed:</p>
<pre class="terminal scrollx"><code>jdk-10.0.2.jdk
jdk1.8.0_181.jdk
jdk1.8.0_131.jdk</code></pre>
<p>and <em>jdk-10.0.2</em> was chosen as the default - because it was the latest. And while the are a <a href="https://superuser.com/questions/682260/how-can-i-set-environment-variables-for-gui-apps-in-os-x-mavericks">number</a> of <a href="https://stackoverflow.com/questions/1348842/what-should-i-set-java-home-to-on-osx/16428639">workarounds</a> for <a href="https://www.ibm.com/support/knowledgecenter/en/SSPJLC_7.6.2/com.ibm.si.mpl.doc/tshoot/ts_java_home.html">this</a>, I chose to go the simple route and moved my <em>jdk-10.0.2</em> installation into an <em>other</em> folder since I didn’t really use it:</p>
<pre class="terminal scrollx"><code>other //my jdk-10.0.2.jdk installation is in here
jdk1.8.0_181.jdk
jdk1.8.0_131.jdk</code></pre>
<p>Consequently when I ran <em>/usr/libexec/java-home</em>, <em>jdk1.8.0_181</em> was the default JDK - which is what I wanted. You can also use something like <a href="https://github.com/jenv/jenv">Jenv</a> to manage your Java environments.</p>
<h3 id="no-build-target-using-presentation-compiler">no build target: using presentation compiler</h3>
<p>This means that <a href="https://github.com/scalacenter/bloop">bloop</a> has not run against your project, which means the project has not been imported. Follow <a href="#no-import-dialog">No Import Dialog</a> to fix.</p>
<h3 id="not-a-valid-command-metalsenable">Not a valid command: metalsEnable</h3>
<p>Sounds like this is some sort of corruption issue, documented <a href="https://github.com/scalameta/metals/issues/685">here</a> or <a href="https://github.com/scalameta/metals/issues/689">here</a>. The log file should reference a <em>sbt-launch.jar</em> in the <em>/tmp</em> directory:</p>
<blockquote>
<p>/tmp/metals-some-long-hash/sbt-launch.jar</p>
</blockquote>
<ul>
<li>Delete the above file</li>
<li>Delete <em>project/target</em> directory</li>
<li>Delete the <em>~/.sbt/1.0/plugins/target/</em> directory</li>
<li>Delete the <em>.bloop</em> directory in your project root</li>
</ul>
<p>Follow <a href="#no-import-dialog">No Import Dialog</a> to reimport the project.</p>
<h3 id="no-.metals-folder-created">No .metals folder created</h3>
<p>You launched the Command Palette with <strong>CMD</strong> + <strong>SHIFT</strong> + <strong>P</strong> and choose <strong>LSP: Enable Language Server in Project</strong> &gt; <strong>metals</strong>. Unfortunately no <em>.metals</em> folder appeared in your project root.</p>
<p>Launch the Command Palette and choose <strong>LSP: Disable Language Server in Project</strong> &gt; <strong>metals</strong>.</p>
<p>Give it a second and try enabling it again with <strong>LSP: Enable Language Server in Project</strong> &gt; <strong>metals</strong>. This should hopefully create the <em>.metals</em> folder. If not try closing the project window in Sublime and trying this workaround again.</p>
<h2 id="whats-not-working">What’s not working</h2>
<p>I couldn’t get imports working. It looks like this works in Visual Studio Code though. At the moment I use my <a href="https://github.com/ssanj/scuggest">Scuggest</a> plugin to fill this gap.</p>
<h2 id="glossary">Glossary</h2>
<h3 id="all-lsp-server-settings">All LSP Server Settings</h3>
<ul>
<li><strong>complete_all_chars</strong> true request completions for all characters, not just trigger characters</li>
<li><strong>only_show_lsp_completions</strong> false disable sublime word completion and snippets from autocomplete lists</li>
<li><strong>completion_hint_type</strong> “auto” override automatic completion hints with “detail”, “kind” or “none”</li>
<li><strong>prefer_label_over_filter_text</strong> false always use the “label” key instead of the “filterText” key in CompletionItems</li>
<li><strong>show_references_in_quick_panel</strong> false show symbol references in Sublime’s quick panel instead of the bottom panel</li>
<li><strong>quick_panel_monospace_font</strong> false use monospace font for the quick panel</li>
<li><strong>show_status_messages</strong> true show messages in the status bar for a few seconds</li>
<li><strong>show_view_status</strong> true show permanent language server status in the status bar</li>
<li><strong>auto_show_diagnostics_panel</strong> true open the diagnostics panel automatically if there are diagnostics</li>
<li><strong>show_diagnostics_phantoms</strong> false show diagnostics as phantoms while the file has no changes</li>
<li><strong>show_diagnostics_count_in_view_status</strong> false show errors and warnings count in the status bar</li>
<li><strong>show_diagnostics_in_view_status</strong> true when on a diagnostic with the cursor, show the text in the status bar</li>
<li><strong>diagnostics_highlight_style</strong> “underline” highlight style of code diagnostics, “underline” or “box”</li>
<li><strong>highlight_active_signature_parameter</strong>: highlight the active parameter of the currently active signature</li>
<li><strong>document_highlight_style</strong>: document highlight style: “underline”, “stippled”, “squiggly” or “”</li>
<li><strong>document_highlight_scopes</strong>: customize your sublime text scopes for document highlighting</li>
<li><strong>diagnostics_gutter_marker</strong> “dot” gutter marker for code diagnostics: “dot”, “circle”, “bookmark”, “cross” or “”</li>
<li><strong>show_code_actions_bulb</strong> false show a bulb in the gutter when code * -* <em>actions</em> are available log_debug false show debug logging in the sublime console</li>
<li><strong>log_server</strong> true show server/logMessage notifications from language - <em>servers</em> in the console</li>
<li><strong>log_stderr</strong> false show language server stderr output in the console log_payloads false show full JSON-RPC responses in the console</li>
</ul>
<h3 id="all-keybindings">All Keybindings</h3>
<div class="sourceCode"><pre class="sourceCode json scrollx"><code class="sourceCode json"><span class="ot">[</span>
    <span class="er">//</span> <span class="er">Show</span> <span class="er">Code</span> <span class="er">Actions</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;super+.&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_code_actions&quot;</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Show/Hide</span> <span class="er">Diagnostics</span> <span class="er">Panel</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;super+alt+m&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_show_diagnostics_panel&quot;</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Go</span> <span class="er">To</span> <span class="er">Next/Previous</span> <span class="er">Diagnostics</span> <span class="er">-</span> <span class="er">THIS</span> <span class="er">OVERRIDES</span> <span class="er">DEFAULT</span> <span class="er">SUBLIME</span> <span class="er">KEYBINDINGS</span>
    <span class="er">//</span> <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;f4&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;next_result&quot;</span> <span class="fu">}</span><span class="ot">,</span>
    <span class="er">//</span> <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;shift+f4&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;prev_result&quot;</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Trigger</span> <span class="er">Signature</span> <span class="er">Help</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;super+alt+space&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;noop&quot;</span><span class="fu">,</span> <span class="dt">&quot;context&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp.signature_help&quot;</span><span class="fu">,</span> <span class="dt">&quot;operator&quot;</span><span class="fu">:</span> <span class="st">&quot;equal&quot;</span><span class="fu">,</span> <span class="dt">&quot;operand&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">}</span><span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Move</span> <span class="er">Up/Down</span> <span class="er">in</span> <span class="er">Signature</span> <span class="er">Help</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;up&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;noop&quot;</span><span class="fu">,</span> <span class="dt">&quot;context&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp.signature_help&quot;</span><span class="fu">,</span> <span class="dt">&quot;operator&quot;</span><span class="fu">:</span> <span class="st">&quot;equal&quot;</span><span class="fu">,</span> <span class="dt">&quot;operand&quot;</span><span class="fu">:</span> <span class="dv">-1</span> <span class="fu">}</span><span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;down&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;noop&quot;</span><span class="fu">,</span> <span class="dt">&quot;context&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp.signature_help&quot;</span><span class="fu">,</span> <span class="dt">&quot;operator&quot;</span><span class="fu">:</span> <span class="st">&quot;equal&quot;</span><span class="fu">,</span> <span class="dt">&quot;operand&quot;</span><span class="fu">:</span> <span class="dv">1</span> <span class="fu">}</span><span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span>

     <span class="er">//</span> <span class="er">Find</span> <span class="er">Symbol</span> <span class="er">References</span>
    <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;shift+f12&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_symbol_references&quot;</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Go</span> <span class="er">To</span> <span class="er">Definition</span>
    <span class="er">//</span> <span class="fu">{</span><span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_symbol_definition&quot;</span><span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Rename</span> <span class="er">Symbol</span>
    <span class="er">//</span> <span class="fu">{</span> <span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_symbol_rename&quot;</span> <span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Format</span> <span class="er">Document</span>
    <span class="er">//</span> <span class="fu">{</span><span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_format_document&quot;</span><span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Format</span> <span class="er">Selection</span>
    <span class="er">//</span> <span class="fu">{</span><span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_format_document_range&quot;</span><span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Document</span> <span class="er">Symbols</span>
    <span class="er">//</span> <span class="fu">{</span><span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_document_symbols&quot;</span><span class="fu">}</span><span class="ot">,</span>

    <span class="er">//</span> <span class="er">Symbol</span> <span class="er">Hover</span>
    <span class="er">//</span> <span class="fu">{</span><span class="dt">&quot;keys&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;UNBOUND&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;lsp_hover&quot;</span><span class="fu">}</span><span class="ot">,</span>
<span class="ot">]</span></code></pre></div>]]></description>
    <pubDate>Tue, 11 Jun 2019 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2019-06-11-running-scala-metals-with-sublime-text-on-macosx.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>Why are Default Parameter Values Considered Bad in Scala?</title>
    <link>http://blog.ssanj.net/posts/2019-05-01-why-are-default-parameter-values-considered-bad-in-scala.html</link>
    <description><![CDATA[<p>There is a very long issue under <a href="https://github.com/wartremover">Wartremover</a> titled: <a href="https://github.com/wartremover/wartremover/issues/116">“Default arguments are insane” needs explanation</a>. Wartremover is a Scala linter that I personally love using as it definitely increases the quality of any Scala code I write.</p>
<p>The issues around using Default Arguments or <a href="https://docs.scala-lang.org/tour/default-parameter-values.html">Default Parameter Values</a> (as Scala refers to them) are somewhat subtle. The Wartemover issue seems to go on forever, but there are lots of really great ideas in there and I though I could summarise some of them here.</p>
<h2 id="what-is-a-default-parameter-value">What is a Default Parameter Value?</h2>
<blockquote>
<p>Scala provides the ability to give parameters default values that can be used to allow a caller to omit those parameters.</p>
</blockquote>
<p>Here’s a quick example of Default Parameter Values (DPV):</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">log</span>(message: String, level: String = <span class="st">&quot;INFO&quot;</span>) = <span class="fu">println</span>(s<span class="st">&quot;$level: $message&quot;</span>)

<span class="fu">log</span>(<span class="st">&quot;System starting&quot;</span>)  <span class="co">//We didn&#39;t supply level which defaults to INFO; prints INFO: System starting</span>
<span class="fu">log</span>(<span class="st">&quot;User not found&quot;</span>, <span class="st">&quot;WARNING&quot;</span>)  <span class="co">// prints WARNING: User not found</span></code></pre></div>
<p>One of the main benefits of DPV is that you don’t need to supply all the parameters to a method - just the ones that are mandatory. This sounds like a really useful idea, so why are people recommending that we don’t use it?</p>
<h2 id="issues">Issues</h2>
<h3 id="unclear-code">1. Unclear Code</h3>
<p>Here’s an example of some code that uses DPV:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">val</span> streamName: String = ...
KinesisStream.<span class="fu">fromUrl</span>(streamName)</code></pre></div>
<p>Now if you just read the above method it looks like it might be doing the wrong thing. Why are we supplying a Stream name to a method that clearly states that it needs a Url?</p>
<p>The method is defined as:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">object</span> KinesisStream {
  <span class="kw">def</span> <span class="fu">fromUrl</span>(streamName: String, url: Option[String] = None): ...
}</code></pre></div>
<p>The default value for <code>url</code> hides the true nature of what this method needs. The <code>url</code> parameter has been made optional because under some circumstances it is not needed.</p>
<h3 id="breaks-currying-and-partial-application">2. <del>Breaks Currying and Partial Application</del></h3>
<p><a href="https://twitter.com/tpolecat">Rob Norris</a> has a nice article on <a href="https://tpolecat.github.io/2014/06/09/methods-functions.html">Methods are not Functions</a> which covers why currying and partial Application of Functions is broken with DPV. Here’s a simple example:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">log</span>(message: String, level: String = <span class="st">&quot;INFO&quot;</span>) = <span class="fu">println</span>(s<span class="st">&quot;$level: $message&quot;</span>)

scala&gt; <span class="fu">log</span>(<span class="st">&quot;hello!&quot;</span>) <span class="co">//one param</span>
INFO: hello!

scala&gt; <span class="fu">log</span>(<span class="st">&quot;hello!&quot;</span>, <span class="st">&quot;WARN&quot;</span>) <span class="co">//both params</span>
WARN: hello!

<span class="co">//can we map over log?</span>
scala&gt; <span class="kw">val</span> messages = List(<span class="st">&quot;hello&quot;</span>, <span class="st">&quot;world&quot;</span>)
messages: List[String] = List(hello, world)

 <span class="co">//does not work</span>
scala&gt; messages.<span class="fu">map</span>(log)
&lt;console&gt;:<span class="dv">14</span>: error: <span class="kw">type</span> mismatch;
 found   : (String, String) =&gt; Unit
 required: String =&gt; ?
       messages.<span class="fu">map</span>(log)
                    ^
 <span class="co">//does not work</span>
scala&gt; messages.<span class="fu">map</span>(log _)
&lt;console&gt;:<span class="dv">14</span>: error: <span class="kw">type</span> mismatch;
 found   : (String, String) =&gt; Unit
 required: String =&gt; ?
       messages.<span class="fu">map</span>(log _)

<span class="co">//works!</span>
scala&gt; messages.<span class="fu">map</span>(<span class="fu">log</span>(_))
INFO: hello
INFO: world
res6: List[Unit] = List((), ())

<span class="co">//also works</span>
scala&gt; messages.<span class="fu">map</span>(x =&gt; <span class="fu">log</span>(x))
INFO: hello
INFO: world
res7: List[Unit] = List((), ())</code></pre></div>
<p>Weird. So it seems like you can use Currying and Partial Application if you tweak the syntax a little.</p>
<p>Let’s have a go with Rob’s example:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">scala&gt; <span class="kw">def</span> <span class="fu">foo</span>(n: Int = <span class="dv">3</span>, s: String) = s * n
foo: (n: Int, s: String)String

<span class="co">//works</span>
scala&gt; <span class="fu">foo</span>(s = <span class="st">&quot;$$&quot;</span>)
res36: String = $$$$$$

<span class="co">//works</span>
scala&gt; <span class="kw">val</span> p1 = <span class="fu">foo</span>(<span class="dv">42</span>, _:String)
p1: String =&gt; String = $$Lambda$<span class="dv">1192</span>/<span class="dv">1172016038</span>@6c826924

scala&gt; <span class="fu">p1</span>(<span class="st">&quot;@&quot;</span>)
res38: String = @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

<span class="co">//can we get defaults for free after conversion to a function?</span>
scala&gt; <span class="kw">val</span> f1 = foo _
f1: (Int, String) =&gt; String = $$Lambda$<span class="dv">1193</span>/<span class="dv">1526085518</span>@205b3a1a

<span class="co">//does not work</span>
scala&gt; <span class="fu">f1</span>(<span class="dv">10</span>)
&lt;console&gt;:<span class="dv">13</span>: error: not enough arguments <span class="kw">for</span> method apply: (v1: Int, v2: String)String in <span class="kw">trait</span> Function2.
Unspecified value parameter v2.
       <span class="fu">f1</span>(<span class="dv">10</span>)

<span class="co">//works</span>
scala&gt; <span class="kw">val</span> p2 = <span class="fu">f1</span>(<span class="dv">10</span>, _: String)
p2: String =&gt; String = $$Lambda$<span class="dv">1408</span>/<span class="dv">1660635397</span>@7f8ac326

scala&gt; <span class="fu">p2</span>(<span class="st">&quot;*&quot;</span>)
res44: String = **********

scala&gt; <span class="kw">val</span> p3 = <span class="fu">f1</span>(_:Int, <span class="st">&quot;$&quot;</span>)
p3 =&gt; String = $$Lambda$<span class="dv">1409</span>/<span class="dv">1435397638</span>@4047789d

scala&gt; <span class="fu">p3</span>(<span class="dv">5</span>)
res48: String = $$$$$

<span class="co">//we can also supply all arguments</span>
scala&gt; <span class="fu">f1</span>(<span class="dv">10</span>, <span class="st">&quot;*&quot;</span>)
res50: String = **********

<span class="co">//use in higher-order functions</span>
scala&gt; messages.<span class="fu">map</span>(p1)
res51: List[String] = List(hellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohello, worldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworldworld)

scala&gt; messages.<span class="fu">map</span>(p2)
res52: List[String] = List(hellohellohellohellohellohellohellohellohellohello, worldworldworldworldworldworldworldworldworldworld)

scala&gt; List(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>).<span class="fu">map</span>(p3)
res53: List[String] = List($, $$, $$$)</code></pre></div>
<p>This seems to be a moot issue. While the syntax is more awkward than necessary, Currying and Partial Application is certainly possible with DPV. Once we η-expand the method <code>foo</code> to the value <code>f1</code>, we lose the defaulted values defined in <code>foo</code> though; which seems a little odd.</p>
<p>Another way to partially apply methods with default parameters is create a wrapper method with only the mandatory fields:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">scala&gt; <span class="kw">def</span> <span class="fu">foo</span>(n: Int = <span class="dv">3</span>, s: String) = s * n
foo: (n: Int, s: String)String

<span class="co">//wrap foo with foo2</span>
scala&gt; <span class="kw">def</span> <span class="fu">foo2</span>(s: String) = <span class="fu">foo</span>(s = s)
foo2: (s: String)String

scala&gt; <span class="fu">foo2</span>(<span class="st">&quot;#&quot;</span>)
res29: String = ###

<span class="co">//now we can use foo2 in higher-order functions</span>
scala&gt; messages.<span class="fu">map</span>(foo2)
res30: List[String] = List(hellohellohello, worldworldworld)</code></pre></div>
<p>The above technique alludes that there should have been two separate methods all along.</p>
<h3 id="bugs-of-convenience">3. Bugs of Convenience</h3>
<p>In a project I worked on we had some asynchronous tasks that split a workload into chunks using a sliding window of ten elements. Here’s a simplified version of the code:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">scala&gt; <span class="kw">val</span> elements = (<span class="dv">1</span> to <span class="dv">30</span>).<span class="fu">toList</span>
elements: List[Int] = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>, <span class="dv">20</span>, <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">24</span>, <span class="dv">25</span>, <span class="dv">26</span>, <span class="dv">27</span>, <span class="dv">28</span>, <span class="dv">29</span>, <span class="dv">30</span>)

scala&gt; <span class="kw">val</span> it = elements.<span class="fu">sliding</span>(<span class="dv">10</span>)
it: Iterator[List[Int]] = non-empty iterator

scala&gt; it.<span class="fu">next</span>
res22: List[Int] = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)

it.<span class="fu">next</span> ??? <span class="co">//what does this print?</span>
it.<span class="fu">next</span> ??? <span class="co">//what does this print?</span></code></pre></div>
<p>We witnessed a subtle bug where performance of our processing pipeline was terrible. What was going on?</p>
<p>The actual definition of <code>sliding</code> is:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> sliding[B &gt;: A](size: Int, step: Int = <span class="dv">1</span>): GroupedIterator[B]</code></pre></div>
<p>Notice the default <strong>step</strong> of 1. When we used the <code>sliding</code> function we assumed that the <code>size</code> supplied would also be the step. Everything compiled and there were no warnings. Here is the output of the above example:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">scala&gt; it.<span class="fu">next</span>
res22: List[Int] = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)

scala&gt; it.<span class="fu">next</span>
res23: List[Int] = List(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>)

scala&gt; it.<span class="fu">next</span>
res24: List[Int] = List(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>)</code></pre></div>
<p>As you can see we were processing the same items multiple times. If the <code>step</code> parameter were explicit this would not have happened. Once the mistake was corrected:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">scala&gt; <span class="kw">val</span> it = elements.<span class="fu">sliding</span>(<span class="dv">10</span>, <span class="dv">10</span>)
it: Iterator[List[Int]] = non-empty iterator

scala&gt; it.<span class="fu">next</span>
res25: List[Int] = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)

scala&gt; it.<span class="fu">next</span>
res26: List[Int] = List(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>, <span class="dv">20</span>)

scala&gt; it.<span class="fu">next</span>
res27: List[Int] = List(<span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">24</span>, <span class="dv">25</span>, <span class="dv">26</span>, <span class="dv">27</span>, <span class="dv">28</span>, <span class="dv">29</span>, <span class="dv">30</span>)</code></pre></div>
<p>We can see the code slides over ten elements at a time as expected. These kind of bugs are hard to find. We lean on the compiler a lot to point out our mistakes. With DPV while our lives are more convenient because we have less parameters to supply our functions, the compiler fails to see our errors and omissions and can’t help.</p>
<h3 id="bugs-due-to-refactoring">4. Bugs due to Refactoring</h3>
<p>Consider an API at version 1.x that has the following method:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">object</span> Database
  <span class="kw">def</span> <span class="fu">fromUrl</span>(url: String): ...
}</code></pre></div>
<p>A client of the library may use it like:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">Database.<span class="fu">fromUrl</span>(<span class="st">&quot;someUrl&quot;</span>)</code></pre></div>
<p>The developer of the library decides to add a <code>tableName</code> parameter as the <code>url</code> is optional when run locally. Not wanting to introduce an additional method for this our developer then decides to make <code>url</code> a DPV.</p>
<p>As this is a breaking change, he bumps the version of the library to 2.x.</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">object</span> Database {
  <span class="kw">def</span> <span class="fu">fromUrl</span>(tableName: String, url: Option[String] = None): ...
}</code></pre></div>
<p>Now this all seems fine. The major version of the library has been bumped so it indicates potential for a breaking change.</p>
<p>Unfortunately, the client code still compiles after moving to version 2.x of the library:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala">Database.<span class="fu">fromUrl</span>(<span class="st">&quot;someUrl&quot;</span>)</code></pre></div>
<p>But now we have problem. Since the location of the <code>url</code> parameter has changed, we are supplying a url as the <code>tableName</code> parameter, and the compiler can’t inform us that anything is broken. We have to find out at runtime that we have a problem.</p>
<h2 id="alternate-designs">Alternate Designs</h2>
<p>Here are some ways to get around using DPV.</p>
<h3 id="supply-all-parameters">Supply all Parameters</h3>
<p>Replace developer convenience for software correctness. Get the developer to supply all parameters. We can change the <code>log</code> function from:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">log</span>(message: String, level: String = <span class="st">&quot;INFO&quot;</span>) = <span class="fu">println</span>(s<span class="st">&quot;$level: $message&quot;</span>)</code></pre></div>
<p>to:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">log</span>(message: String, level: String) = <span class="fu">println</span>(s<span class="st">&quot;$level: $message&quot;</span>)</code></pre></div>
<p>Callers of the <code>log</code> method have to now supply both the <code>message</code> and the <code>level</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="fu">log</span>(<span class="st">&quot;System starting&quot;</span>, <span class="st">&quot;INFO&quot;</span>)</code></pre></div>
<p>Better yet, convert the <code>level</code> parameter to an ADT so that the callers can’t pass through invalid values.</p>
<p>However this technique can get tedious if you have a lot of parameters that you don’t really care about.</p>
<h3 id="breakout-separate-methods">Breakout Separate Methods</h3>
<p>If you don’t want to supply all the parameters each time, consider creating separate methods for the situations you care about.</p>
<p>In the case of the bug with the Database refactoring, we could have pulled out some extra methods:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">object</span> Database {
  <span class="kw">def</span> <span class="fu">remote</span>(url: DatabaseUrl): ...
  <span class="kw">def</span> <span class="fu">remoteWithTable</span>(tableName: String, url: DatabaseUrl): ...
  <span class="kw">def</span> <span class="fu">local</span>(tableName: String): ...
}</code></pre></div>
<p><a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51173792">Rob Norris on splitting out methods</a>:</p>
<blockquote>
<p>If you have a method with a single default arg you could reasonably suggest splitting it into two methods (as you might do with a single option or boolean arg)</p>
</blockquote>
<h3 id="have-a-default-object">Have a Default Object</h3>
<p>If you have a lot of parameters to your function (and this might be a problem by itself) you could use a default object.</p>
<p>Take <code>tcpConnect</code> as an example:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">tcpConnect</span>(host: String, port: Int = <span class="dv">80</span>, sslEncryption: Boolean = <span class="kw">false</span>, localAddress: Option[String] = None):  String = <span class="st">&quot;connected&quot;</span></code></pre></div>
<p>This could be re-written with a default object:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="co">//original method with defaults removed</span>
<span class="kw">def</span> <span class="fu">tcpConnect</span>(host: String, port: Int, sslEncryption: Boolean, localAddress: Option[String]):  String = <span class="st">&quot;connected&quot;</span>

<span class="co">//config class</span>
<span class="kw">case</span> <span class="kw">class</span> <span class="fu">TcpConnection</span>(host: String, port: Int, sslEncryption: Boolean, localAddress: Option[String])

<span class="co">//function that calls tcpConnect</span>
<span class="kw">def</span> <span class="fu">fromTcpConnection</span>(tcpConnection: TcpConnection): String =
  <span class="fu">tcpConnect</span>(tcpConnection.<span class="fu">host</span>, tcpConnection.<span class="fu">port</span>, tcpConnection.<span class="fu">sslEncryption</span>, tcpConnection.<span class="fu">localAddress</span>)

<span class="co">//default object</span>
<span class="kw">def</span> defaultTcpConnection: TcpConnection = <span class="fu">TcpConnction</span>(host: String = <span class="st">&quot;localhost&quot;</span>, port: Int = <span class="dv">80</span>, sslEncryption: Boolean = <span class="kw">false</span>, localAddress: Option[String] = None)

<span class="co">//usage for a specific URL</span>
<span class="fu">fromTcpConnection</span>(defaultTcpConnection.<span class="fu">copy</span>(host = <span class="st">&quot;http://....&quot;</span>))

<span class="co">//usage for a specific port</span>
<span class="fu">fromTcpConnection</span>(defaultTcpConnection.<span class="fu">copy</span>(port = <span class="dv">8080</span>))

<span class="co">//usage for a secure URL</span>
<span class="fu">fromTcpConnection</span>(defaultTcpConnection.<span class="fu">copy</span>(host = <span class="st">&quot;https://...&quot;</span>, port = <span class="dv">443</span>, sslEncryption = <span class="kw">true</span>))</code></pre></div>
<p><a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51173792">Rob Norris on using default config objects</a>:</p>
<blockquote>
<p>… right, but then you have the awful copy method to contend with, then you add lenses, then you add phantom types to ensure that options haven’t been set more than once, etc., etc., and I’m not convinced that the complexity is warranted, given the lack thus far of any convincing reason not to use default args</p>
</blockquote>
<p>As Rob mentions, depending on how far you want to take it, avoiding DPVs might lead to very complex solutions.</p>
<p>As <a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51172733">Maxwell Swadling points out</a> you could also break out separate methods for this:</p>
<div class="sourceCode"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">connectHTTP</span>(host: String):  String <span class="co">//where port = 80, sslEncryption = false, localAddress = None</span>
<span class="kw">def</span> <span class="fu">connectHTTPPort</span>(host: String, port: Int):  String <span class="co">//where sslEncryption = false, localAddress = None</span>
<span class="kw">def</span> <span class="fu">connectHTTPS</span>(host: String):  String <span class="co">//where port = 443, sslEncryption = true, , localAddress = None</span>
<span class="kw">def</span> <span class="fu">tcpConnect</span>(host: String, port: Int, sslEncryption: Boolean, localAddress: Option[String]):  String <span class="co">//the normal connect with all the arguments.</span></code></pre></div>
<p>If none of these alternates seem attractive, go ahead and use DPV but think hard about how it may introduce bugs into your code base.</p>
<h2 id="parting-thoughts">Parting Thoughts</h2>
<p><a href="https://twitter.com/markhibberd">Mark Hibberd</a> recommends not using DPV for the <a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51326211">following</a>:</p>
<ol style="list-style-type: decimal">
<li><strong>Allocation of resources</strong> (there are even examples of this in scalaz) - which is utterly wrong. Anything that is allocated by a default argument has no reasonable lifecycle and is unlikely (or impossible) to be closed properly.</li>
<li><strong>Default configurations</strong> - these are a developer convenience that lead to operational bugs. There is no such thing as a “safe” default, where it could mean forgetting to set something in production leads to an incorrect value rather than an error (this is closely related to what Minsky says as mentioned by Eric above).</li>
<li><strong>Common arguments through delegating methods</strong> - these are representative of what <span class="citation">@maxpow4h</span> originally stated. That if you have multiple methods with optional arguments, it is extremely easy for incorrect code to compile by forgetting to delegate one of the arguments.</li>
<li><strong>Faux overloading</strong> - it is cool to hate on overloading so I will avoid it by using named arguments with defaults, ending up with the exact same situation. Code that is subtly wrong (such as forgetting to pass argument) still compiles. This is not an acceptable situation.</li>
</ol>
<p><a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51268242">Eric Torreborre on when to use DPV</a>:</p>
<blockquote>
<p>So my own conclusion is that default arguments (and overloading) still have some value (for non-critical DSLs) but you need to be very careful where you use them.</p>
</blockquote>
<p><a href="https://github.com/wartremover/wartremover/issues/116#issuecomment-51280344">Mark Hibberd on focussing on correct programs</a>:</p>
<blockquote>
<p>But the most troublesome part of this thread, is that almost all of the discussion is about what developers find “convenient” and aesthetically pleasing, when we should be asking how a language feature adds or removes from our ability to build robust, correct programs - and, as quickly as possible. When held in this light, default arguments do not hold up. They are a mere syntactic convenience - that does not help us with this goal. This might be ok, if they didn’t come with risk or issues, but even the gentler arguments in this thread should be enough to highlight their use in a linting tool - especially given their inherent lack of motivation to begin with.</p>
</blockquote>
<blockquote>
<p>But yeh. Everyone gets to live in their own teams codebases. I just prefer mine without these undue risks.</p>
</blockquote>
<p>So in summary:</p>
<ol style="list-style-type: decimal">
<li>Don’t use DPV in production code. This could lead to bugs that are hard to find</li>
<li>Possibly use DPV in non-production code like such as test DSLs</li>
<li>If DPV helps to reduce the number of methods or the complexity of your solution, consider using it but be aware of the consequences. Alternatively redesign your code so it does not require DPV.</li>
</ol>]]></description>
    <pubDate>Wed, 01 May 2019 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2019-05-01-why-are-default-parameter-values-considered-bad-in-scala.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>What is SBT Doing?</title>
    <link>http://blog.ssanj.net/posts/2019-04-10-what-is-sbt-doing.html</link>
    <description><![CDATA[<p>Sometimes when you start up SBT and run a command, it sits there doing nothing for a long while. Wouldn’t it be nice to see what’s going or where it’s spending all its time?</p>
<p>It turns out you can. Simply start SBT in debug mode:</p>
<pre class="command scrollx"><code>sbt --debug</code></pre>
<p>Then rerun your command and watch all the information fly by about what SBT is up to.</p>]]></description>
    <pubDate>Wed, 10 Apr 2019 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2019-04-10-what-is-sbt-doing.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>Xiaomi Mi A1 Hotspot Fix on Telstra</title>
    <link>http://blog.ssanj.net/posts/2018-10-30-xiaomi-mi-a1-hotspot-fix.html</link>
    <description><![CDATA[<div class="figure">
<img src="https://i01.appmifile.com/webfile/globalimg/zh/goods/mi_a1/kind-red.jpg" alt="xma" />
<p class="caption">xma</p>
</div>
<p>I’m really enjoying having moved to the <a href="https://www.mi.com/in/mi-a1">Xiaomi Mi A1</a> from my iPhone 6. For $A250 that’s an absolute steal. One issue that has plague this phone is that the hotspot does not work as advertised. This has been an issue until recently when I stumbled across a fix that worked for me:</p>
<ol style="list-style-type: decimal">
<li><p>Got to <em>Settings</em> &gt; <em>Network &amp; Internet</em> &gt; <em>Mobile Network</em> &gt; <em>Advanced</em> &gt; <em>Access Point Names</em> &gt; <em>Telstra Internet</em></p></li>
<li><p>Change <strong>APN</strong> Type from:</p></li>
</ol>
<pre class="terminal scrollx"><code>default, supl</code></pre>
<p>to</p>
<pre class="terminal scrollx"><code>default,supl,dun</code></pre>
<p>And that should be about it. Happy hotspotting! :)</p>]]></description>
    <pubDate>Tue, 30 Oct 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-10-30-xiaomi-mi-a1-hotspot-fix.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>Rebasing with Git Pull by Default</title>
    <link>http://blog.ssanj.net/posts/2018-10-30-rebasing-with-git-pull-by-default.html</link>
    <description><![CDATA[<p>Sometimes when pulling changes from a remote repository you are left with a somewhat ugly merge. This leaves you wishing you had rebased instead. Wouldn’t it be nice if you could rebase everytime you <code>git pull</code> automatically? And now you can with another simple configuration option:</p>
<pre class="command scrollx"><code>git config --global --bool pull.rebase true</code></pre>]]></description>
    <pubDate>Tue, 30 Oct 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-10-30-rebasing-with-git-pull-by-default.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>How to Push Git Tags with Commit</title>
    <link>http://blog.ssanj.net/posts/2018-10-30-how-to-push-git-tags-with-commit.html</link>
    <description><![CDATA[<p>When pushing code that has some tags to a remote repository, you need to first push the commits with:</p>
<pre class="command scrollx"><code>git push</code></pre>
<p>and then follow with:</p>
<pre class="command scrollx"><code>git push --tags</code></pre>
<p>Wouldn’t it be nice if you could push the commits and tags in one go? Well now you can by setting one simple config option:</p>
<pre class="command scrollx"><code>git config --global push.followTags true</code></pre>
<p>From the git documentation:</p>
<blockquote>
<p>push.followTags If set to true enable –follow-tags option by default. You may override this configuration at time of push by specifying –no-follow-tags.</p>
</blockquote>
<blockquote>
<p>–follow-tags Push all the refs that would be pushed without this option, and also push annotated tags in refs/tags that are missing from the remote but are pointing at commit-ish that are reachable from the refs being pushed.</p>
</blockquote>
<p>References:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/3745135/push-git-commits-tags-simultaneously">Push git commits &amp; tags simultaneously</a>,</li>
<li><a href="https://git-scm.com/docs/git-config/2.4.1">git-conig</a></li>
</ul>]]></description>
    <pubDate>Tue, 30 Oct 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-10-30-how-to-push-git-tags-with-commit.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>How to Show Git Commit Hash for Tags</title>
    <link>http://blog.ssanj.net/posts/2018-10-17-how-to-show-git-commit-hash-for-tags.html</link>
    <description><![CDATA[<p>To list the commit hash for every tag in a repo use:</p>
<pre class="command scrollx"><code>git show-ref --tags</code></pre>
<p>which yields something like:</p>
<pre class="terminal scrollx"><code>ee02aa7363f9988af700ab136a219c455cab4b5f refs/tags/v.0.4.0
2d5befba5bc80a69c6308d2a5da965488e6bf9d7 refs/tags/v.0.4.1
0099c11405a3ace8ee14b0881f9677bfc1e30f5e refs/tags/v0.4.1</code></pre>
<p>To only list the commit hash for a particular tag use:</p>
<pre class="command scrollx"><code>git show-ref tag_name</code></pre>
<p>for example, to list the commit hash for v0.4.1 use:</p>
<pre class="command scrollx"><code>git show-ref v0.4.1</code></pre>
<p>which gives you a single hash:</p>
<pre class="terminal scrollx"><code>0099c11405a3ace8ee14b0881f9677bfc1e30f5e refs/tags/v0.4.1</code></pre>
<p>To display the contents of a hash use:</p>
<pre class="command scrollx"><code>git show hash</code></pre>]]></description>
    <pubDate>Wed, 17 Oct 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-10-17-how-to-show-git-commit-hash-for-tags.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>Defining a multiline function in Haskell using Ghci</title>
    <link>http://blog.ssanj.net/posts/2018-08-09-defining-a-multiline-function-in-haskell-using-ghci.html</link>
    <description><![CDATA[<p>I’ve always found it difficult to remember the exact syntax for setting Ghci into multiline mode and defining a function therein. Below are the steps for easy access.</p>
<p>Start by setting Ghci into multiline mode with:</p>
<pre class="command scrollx"><code>:set +m</code></pre>
<p>You can start a multiline block with <code>:{</code> and end it with <code>:}</code>.</p>
<p>Function definitions must be preceded with <code>let</code>. This has tripped me up many times.</p>
<p>For example, to define a function that pauses for a given delay before printing out “done”:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="fu">:</span>{
  <span class="kw">let</span><span class="ot"> printAfter ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
      printAfter delay <span class="fu">=</span>
        <span class="kw">do</span> putStrLn <span class="fu">$</span> (\d <span class="ot">-&gt;</span> <span class="st">&quot;waiting for &quot;</span> <span class="fu">++</span> d <span class="fu">++</span> <span class="st">&quot; microseconds&quot;</span>) <span class="fu">$</span> show delay
           threadDelay delay
           putStrLn <span class="st">&quot;done&quot;</span>
<span class="fu">:</span>}</code></pre></div>
<p>To unset multiline mode use:</p>
<pre class="command scrollx"><code>:unset +m</code></pre>
<p>References: <a href="https://stackoverflow.com/questions/8443035/multi-line-commands-in-ghci">Multi-line commands in GHCi</a>, <a href="https://stackoverflow.com/questions/2846050/how-to-define-a-function-in-ghci-across-multiple-lines">How to define a function in ghci across multiple lines?</a></p>]]></description>
    <pubDate>Thu, 09 Aug 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-08-09-defining-a-multiline-function-in-haskell-using-ghci.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>Loading a Package into GHCi through Stack</title>
    <link>http://blog.ssanj.net/posts/2018-04-10-loading-a-package-into-ghci-through-stack.html</link>
    <description><![CDATA[<p>Ever wanted to play around with a particular set of packages in GHCi but didn’t want to setup a project? You’re in luck. With Stack you can now selectively load named packages and launch directly into GHCi. The incantation you need is:</p>
<pre class="terminal scrollx"><code>stack ghci --package [package-name1] --package [package-name2]</code></pre>
<p>For example to load the transformers package:</p>
<pre class="terminal scrollx"><code>stack ghci --package transformers</code></pre>
<p>And now we have transformers loaded in GHCi:</p>
<pre class="command scrollx"><code>*Main Lib&gt; import Control.Monad.
Control.Monad.Fail                 Control.Monad.Trans.Except
Control.Monad.Fix                  Control.Monad.Trans.Identity
Control.Monad.IO.Class             Control.Monad.Trans.List
Control.Monad.Instances            Control.Monad.Trans.Maybe
Control.Monad.ST                   Control.Monad.Trans.RWS
Control.Monad.ST.Lazy              Control.Monad.Trans.RWS.Lazy
Control.Monad.ST.Lazy.Safe         Control.Monad.Trans.RWS.Strict
Control.Monad.ST.Lazy.Unsafe       Control.Monad.Trans.Reader
Control.Monad.ST.Safe              Control.Monad.Trans.State
Control.Monad.ST.Strict            Control.Monad.Trans.State.Lazy
Control.Monad.ST.Unsafe            Control.Monad.Trans.State.Strict
Control.Monad.Signatures           Control.Monad.Trans.Writer
Control.Monad.Trans.Class          Control.Monad.Trans.Writer.Lazy
Control.Monad.Trans.Cont           Control.Monad.Trans.Writer.Strict
Control.Monad.Trans.Error          Control.Monad.Zip
*Main Lib&gt; import Control.Monad.Trans.Writer.Lazy</code></pre>
<p><a href="https://stackoverflow.com/questions/39848576/load-a-new-package-in-ghci-using-stack#39848577">Reference</a></p>]]></description>
    <pubDate>Tue, 10 Apr 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-04-10-loading-a-package-into-ghci-through-stack.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>
<item>
    <title>How does filterM work in Haskell?</title>
    <link>http://blog.ssanj.net/posts/2018-04-10-how-does-filterm-work-in-haskell.html</link>
    <description><![CDATA[<p><strong>filterM</strong> is an interesting function. In one sense it’s very similar to <strong>filter</strong> which we all know and love. It’s much more powerful though as we shall soon see. Let’s start by having a look at the definition of <strong>filter</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filter<span class="ot"> ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</code></pre></div>
<p>and then at filterM:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">filterM ::</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> m [a]</code></pre></div>
<p>A side-by-side comparison:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filter<span class="ot"> ::</span>                   (a <span class="ot">-&gt;</span>   <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span>   [a]
<span class="ot">filterM ::</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> m [a]</code></pre></div>
<p>By comparing the type signatures of <strong>filter</strong> and <strong>filterM</strong> we can see that <strong>filterM</strong> is just <strong>filter</strong> where the conditional expression yields a <strong>Bool</strong> within a context <strong>m</strong> and where the matching results are aggregated in the <strong>m</strong> context.</p>
<p>The implementation of <strong>filterM</strong> in <a href="https://hackage.haskell.org/package/base-4.11.0.0/docs/src/Control.Monad.html#filterM">GCH base</a> is as follows:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">filterM   ::</span> (<span class="dt">Applicative</span> m) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> m [a]
filterM p <span class="fu">=</span> foldr (\x <span class="ot">-&gt;</span> liftA2 (\flg <span class="ot">-&gt;</span> <span class="kw">if</span> flg <span class="kw">then</span> (x<span class="fu">:</span>) <span class="kw">else</span> id) (p x)) (pure [])</code></pre></div>
<p>From the above definition it looks like whenever the monadic filter function <code>(a -&gt; m Bool)</code> returns a <code>m True</code>, the value in the supplied list is prepended to an accumulator, and if it doesn’t match the existing accumulator is left unchanged.</p>
<p>Although this sound very simple, I found the usage of <strong>filterM</strong> to be somewhat difficult to understand - at least at first. Let’s start investigating its usage by looking at some example instances for <strong>m</strong>.</p>
<h2 id="maybe">Maybe</h2>
<p>Given a list of numbers:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">numbers ::</span> [<span class="dt">Int</span>]
numbers <span class="fu">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>]</code></pre></div>
<p>and an <strong>isEven</strong> function:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">isEven ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>
isEven n <span class="fu">=</span> n <span class="ot">`mod`</span> <span class="dv">2</span> <span class="fu">==</span> <span class="dv">0</span></code></pre></div>
<p>we can use <strong>filterM</strong> to filter the list of numbers that are even and return the results in a <strong>Maybe</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (<span class="dt">Just</span> <span class="fu">.</span> isEven) numbers</code></pre></div>
<p>which results in:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="dt">Just</span> [<span class="dv">2</span>,<span class="dv">4</span>]</code></pre></div>
<p>That seems pretty easy. Using <strong>filter</strong> on <strong>numbers</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filter isEven numbers</code></pre></div>
<p>we get:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">[<span class="dv">2</span>,<span class="dv">4</span>]</code></pre></div>
<p>The only difference between the results being that the <strong>filterM</strong> variant has the results in the <strong>Maybe</strong> Monad.</p>
<p>What happens when <strong>filterM</strong> takes a function that can return <strong>Nothing</strong> in some instances?</p>
<p>Given the following function:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">isDivisibleByThree ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>
isDivisibleByThree n <span class="fu">=</span> n <span class="ot">`mod`</span> <span class="dv">3</span> <span class="fu">==</span> <span class="dv">0</span></code></pre></div>
<p>Let’s filter our list of numbers so that they contain even numbers, but if we encounter a number that is divisible by three, we want to bail on the result:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (\n <span class="ot">-&gt;</span> <span class="kw">if</span> isDivisibleByThree n <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (isEven n)) numbers</code></pre></div>
<p>this results in:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="dt">Nothing</span></code></pre></div>
<p>Now, this might be a little surprising. What happened to all the matches until we encountered a three, such as two? Recall that the <strong>filterM</strong> implementation:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM p <span class="fu">=</span> foldr (\x <span class="ot">-&gt;</span> liftA2 (\flg <span class="ot">-&gt;</span> <span class="kw">if</span> flg <span class="kw">then</span> (x<span class="fu">:</span>) <span class="kw">else</span> id) (p x)) (pure [])</code></pre></div>
<p>uses <strong>liftA2</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">liftA2 ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> f b <span class="ot">-&gt;</span> f c</code></pre></div>
<p>to run a binary function over the Applicative instances. With two <strong>Maybe</strong> instances, the result is always <strong>Nothing</strong>, if one of them is <strong>Nothing</strong> as you can’t run the function without both inputs:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">liftA2 (<span class="fu">+</span>) (<span class="dt">Just</span> <span class="dv">1</span>) (<span class="dt">Just</span> <span class="dv">2</span>) <span class="fu">=</span> <span class="dt">Just</span> <span class="dv">3</span>
liftA2 (<span class="fu">+</span>) (<span class="dt">Just</span> <span class="dv">1</span>) <span class="dt">Nothing</span>  <span class="fu">=</span> <span class="dt">Nothing</span>
liftA2 (<span class="fu">+</span>) <span class="dt">Nothing</span> (<span class="dt">Just</span> <span class="dv">2</span>)  <span class="fu">=</span> <span class="dt">Nothing</span>
liftA2 (<span class="fu">+</span>) <span class="dt">Nothing</span> <span class="dt">Nothing</span>   <span class="fu">=</span> <span class="dt">Nothing</span></code></pre></div>
<p>What this demonstrates is that if we ever receive a <strong>Nothing</strong> value while using <strong>filterM</strong> all results up until that point are discarded. This highlights one key difference between <strong>filter</strong> and <strong>filterM</strong>; in addition to filtering on the <strong>Bool</strong> result, <strong>filterM</strong> also combines the results using its Applicative properties.</p>
<p>Let’s run the <strong>filterM</strong> code once again, but this time, we’ll leave out any multiples of three:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (\n <span class="ot">-&gt;</span> <span class="kw">if</span> isDivisibleByThree n <span class="kw">then</span> <span class="dt">Nothing</span> <span class="kw">else</span> <span class="dt">Just</span> (isEven n)) [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">8</span>]</code></pre></div>
<p>and this time the answer is:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="dt">Just</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>]</code></pre></div>
<h2 id="io">IO</h2>
<p>Let’s try filtering only even numbers using the <strong>IO</strong> Monad:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">ioFilterM (pure <span class="fu">.</span> isEven) numbers
<span class="fu">=</span> [<span class="dv">2</span>, <span class="dv">4</span>] <span class="co">-- IO [Int]</span></code></pre></div>
<p>That works as expected. Now let’s introduce a failure in <strong>IO</strong> Monad when a number is divisible by three:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (\n <span class="ot">-&gt;</span> <span class="kw">if</span> isDivisibleByThree n <span class="kw">then</span> ioError (userError <span class="st">&quot;boom!&quot;</span>) <span class="kw">else</span> pure (isEven n)) numbers
<span class="fu">=</span> <span class="fu">***</span> <span class="dt">Exception</span><span class="fu">:</span> user error (boom<span class="fu">!</span>) <span class="co">-- IO [Int]</span></code></pre></div>
<p>The above discards any results collected once it reaches an <strong>IO</strong> error. This functionality is very similar to how the <strong>Maybe</strong> Monad filtered when it received a <strong>Nothing</strong>. This is quite useful when filtering only valid results and failing on the first failure.</p>
<p>And if we remove any numbers divisible by three:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (\n <span class="ot">-&gt;</span> <span class="kw">if</span> isDivisibleByThree n <span class="kw">then</span> ioError (userError <span class="st">&quot;boom!&quot;</span>) <span class="kw">else</span> pure (isEven n)) [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">8</span>]
<span class="fu">=</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>] <span class="co">-- IO [Int]</span></code></pre></div>
<p>we get back the expected results.</p>
<h2 id="list">List</h2>
<p>With List, things get more interesting. Consider the following:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM (\n <span class="ot">-&gt;</span> [<span class="dt">True</span>, <span class="dt">False</span>]) numbers</code></pre></div>
<p>What do you reckon the answer would be? Probably not a <a href="https://en.wikipedia.org/wiki/Power_set">powerset</a>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">[[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">2</span>],
[<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>],[<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">3</span>],[<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">1</span>,<span class="dv">4</span>],[<span class="dv">1</span>,<span class="dv">5</span>],[<span class="dv">1</span>],[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]
,[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">2</span>,<span class="dv">3</span>],[<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">2</span>,<span class="dv">4</span>],[<span class="dv">2</span>,<span class="dv">5</span>],[<span class="dv">2</span>],[<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">3</span>,<span class="dv">4</span>],[<span class="dv">3</span>,<span class="dv">5</span>],[<span class="dv">3</span>],[<span class="dv">4</span>,<span class="dv">5</span>],[<span class="dv">4</span>],
[<span class="dv">5</span>],[]]</code></pre></div>
<p>Remember that <strong>filterM</strong> is defined as:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM p <span class="fu">=</span> foldr (\x <span class="ot">-&gt;</span> liftA2 (\flg <span class="ot">-&gt;</span> <span class="kw">if</span> flg <span class="kw">then</span> (x<span class="fu">:</span>) <span class="kw">else</span> id) (p x)) (pure [])</code></pre></div>
<p>How does this work with List? If we use <strong>liftA2</strong> with List:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">liftA2 (<span class="fu">+</span>) [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] [<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]
<span class="fu">=</span> [<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>]</code></pre></div>
<p>we see that we get a <a href="https://en.wikipedia.org/wiki/Cartesian_product">Cartesian product</a> of values (all combinations). List is a non-deterministic Monad and as such it produces results of every possible combination.</p>
<p>Let’s start by expanding out the point-free implementation of <strong>filterM</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell">filterM p <span class="fu">=</span>
  foldr (\x acc <span class="ot">-&gt;</span> liftA2 (\flg1 accx <span class="ot">-&gt;</span> <span class="kw">if</span> flg1 <span class="kw">then</span> (x<span class="fu">:</span>accx) <span class="kw">else</span> accx) (p x) acc) (pure [])</code></pre></div>
<p><strong>accx</strong> is the accumulator value passed to <strong>liftA2</strong>. The values passed will be the Cartesian product of <strong>[True, False]</strong> and the accumulator of list <strong>acc</strong>, which is initially <strong>[[]]</strong>.</p>
<p>There are two main expansions happening in the implementation of <strong>filterM</strong>:</p>
<ol style="list-style-type: decimal">
<li><strong>liftA2</strong> is creating a Cartesian product of the flags <strong>[True, False]</strong> and the accumulator <strong>acc</strong> and combining them with supplied function, which prepends the current value of the list <strong>x</strong> to the accumulator <strong>accx</strong> if the flag is True or returns the existing accumulator <strong>accx</strong> if it is False.</li>
<li>All the combinations returned from <strong>listA2</strong> are then returned into <strong>foldr</strong> as the new value of the accumulator <strong>acc</strong>.</li>
</ol>
<p>Because <strong>filterM</strong> is implemented using <strong>foldr</strong> the accumulated values are used from last to first.</p>
<p>Given the following legend:</p>
<pre class="terminal scrollx"><code>x      -- element in the list
acc    -- value of accumulator
accx   -- value of accumulator at current combination
flg1   -- value of flag at current combination
result -- value of accx after applying flg1
newacc -- value of acc returned to foldr</code></pre>
<p>Let’s start from the end of the list at 5 and follow it up to 1.</p>
<p>For the value of 5:</p>
<pre class="terminal scrollx"><code>x = 5
acc = [[]]
flags = [True, False]
--------------------
accx []
flg1 True
result = 5:[] =&gt; [5]
--------------------
accx []
flg1 False
result =&gt; []
--------------------
newacc = [[5], []]</code></pre>
<p>For the value of 4:</p>
<pre class="terminal scrollx"><code>x = 4
acc = [[5], []]
flags = [True, False]
--------------------
accx [5]
flg1 True
result = 4:[5] =&gt; [4,5]
--------------------
accx []
flg1 True
result = 4:[] =&gt; [4]
--------------------
accx [5]
flg1 False
result =&gt; [5]
--------------------
accx []
flg1 False
result =&gt; []
--------------------
newacc = [[4,5],[4],[5], []]</code></pre>
<p>For the value of 3:</p>
<pre class="terminal scrollx"><code>x = 3
acc = [[4,5],[4],[5], []]
flags = [True, False]
--------------------
accx [4,5]
flg1 True
result = 3:[4,5] =&gt; [3,4,5]
--------------------
accx [4]
flg1 True
result = 3:[4] =&gt; [3,4]
--------------------
accx [5]
flg1 True
result = 3:[5] =&gt; [3,5]
--------------------
accx []
flg1 True
result = 3:[] =&gt; [3]
--------------------
accx [4,5]
flg1 False
result =&gt; [4,5]
--------------------
accx [4]
flg1 False
result =&gt; [4]
--------------------
accx [5]
flg1 False
result =&gt; [5]
--------------------
accx []
flg1 False
result =&gt; []
--------------------
newacc = [[3,4,5],[3,4],[3,5],[3],[4,5],[4],[5],[]]</code></pre>
<p>For the value of 2:</p>
<pre class="terminal scrollx"><code>x = 2
acc = [[3,4,5],[3,4],[3,5],[3],[4,5],[4],[5],[]]
flags = [True, False]
--------------------
accx [3,4,5]
flg1 True
result = 2:[3,4,5] =&gt; [2,3,4,5]
--------------------
accx [3,4]
flg1 True
result = 2:[3,4] =&gt; [2,3,4]
--------------------
accx [3,5]
flg1 True
result = 2:[3,5] =&gt; [2,3,5]
--------------------
accx [3]
flg1 True
result = 2:[3] =&gt; [2,3]
--------------------
accx [4,5]
flg1 True
result = 2:[4,5] =&gt; [2,4,5]
--------------------
accx [4]
flg1 True
result = 2:[4] =&gt; [2,4]
--------------------
accx [5]
flg1 True
result = 2:[5] =&gt; [2,5]
--------------------
accx []
flg1 True
result = 2:[] =&gt; [2]
--------------------
accx [3,4,5]
flg1 False
result =&gt; [3,4,5]
--------------------
accx [3,4]
flg1 False
result =&gt; [3,4]
--------------------
accx [3,5]
flg1 False
result =&gt; [3,5]
--------------------
accx [3]
flg1 False
result =&gt; [3]
--------------------
accx [4,5]
flg1 False
result =&gt; [4,5]
--------------------
accx [4]
flg1 False
result =&gt; [4]
--------------------
accx [5]
flg1 False
result =&gt; [5]
--------------------
accx []
flg1 False
result =&gt; []
--------------------
newacc = [[2,3,4,5],[2,3,4],[2,3,5],[2,3],[2,4,5],[2,4],[2,5],[2],[3,4,5],[3,4],[3,5],[3],[4,5],[4],[5],[]]</code></pre>
<p>For the value of 1:</p>
<pre class="terminal scrollx"><code>x = 1
acc = [[2,3,4,5],[2,3,4],[2,3,5],[2,3],[2,4,5],[2,4],[2,5],[2],[3,4,5],[3,4],[3,5],[3],[4,5],[4],[5],[]]
flags = [True, False]
--------------------
accx [2,3,4,5]
flg1 True
result = 1:[2,3,4,5] =&gt; [1,2,3,4,5]
--------------------
accx [2,3,4]
flg1 True
result = 1:[2,3,4] =&gt; [1,2,3,4]
--------------------
accx [2,3,5]
flg1 True
result = 1:[2,3,5] =&gt; [1,2,3,5]
--------------------
accx [2,3]
flg1 True
result = 1:[2,3] =&gt; [1,2,3]
--------------------
accx [2,4,5]
flg1 True
result = 1:[2,4,5] =&gt; [1,2,4,5]
--------------------
accx [2,4]
flg1 True
result = 1:[2,4] =&gt; [1,2,4]
--------------------
accx [2,5]
flg1 True
result = 1:[2,5] =&gt; [1,2,5]
--------------------
accx [2]
flg1 True
result = 1:[2] =&gt; [1,2]
--------------------
accx [3,4,5]
flg1 True
result = 1:[3,4,5] =&gt; [1,3,4,5]
--------------------
accx [3,4]
flg1 True
result = 1:[3,4] =&gt; [1,3,4]
--------------------
accx [3,5]
flg1 True
result = 1:[3,5] =&gt; [1,3,5]
--------------------
accx [3]
flg1 True
result = 1:[3] =&gt; [1,3]
--------------------
accx [4,5]
flg1 True
result = 1:[4,5] =&gt; [1,4,5]
--------------------
accx [4]
flg1 True
result = 1:[4] =&gt; [1,4]
--------------------
accx [5]
flg1 True
result = 1:[5] =&gt; [1,5]
--------------------
accx []
flg1 True
result = 1:[] =&gt; [1]
-------------------- *
accx [2,3,4,5]
flg1 False
result =&gt; [2,3,4,5]
--------------------
accx [2,3,4]
flg1 False
result =&gt; [2,3,4]
--------------------
accx [2,3,5]
flg1 False
result =&gt; [2,3,5]
--------------------
accx [2,3]
flg1 False
result =&gt; [2,3]
--------------------
accx [2,4,5]
flg1 False
result =&gt; [2,4,5]
--------------------
accx [2,4]
flg1 False
result =&gt; [2,4]
--------------------
accx [2,5]
flg1 False
result =&gt; [2,5]
--------------------
accx [2]
flg1 False
result =&gt; [2]
--------------------
accx [3,4,5]
flg1 False
result =&gt; [3,4,5]
--------------------
accx [3,4]
flg1 False
result =&gt; [3,4]
--------------------
accx [3,5]
flg1 False
result =&gt; [3,5]
--------------------
accx [3]
flg1 False
result =&gt; [3]
--------------------
accx [4,5]
flg1 False
result =&gt; [4,5]
--------------------
accx [4]
flg1 False
result =&gt; [4]
--------------------
accx [5]
flg1 False
result =&gt; [5]
--------------------
accx []
flg1 False
result =&gt; []
--------------------

newacc = [[1,2,3,4,5],[1,2,3,4],[1,2,3,5],[1,2,3],[1,2,4,5],[1,2,4],[1,2,5],[1,2],[1,3,4,5],[1,3,4],[1,3,5],[1,3],[1,4,5],[1,4],[1,5],[1],[2,3,4,5],[2,3,4],[2,3,5],[2,3],[2,4,5],[2,4],[2,5],[2],[3,4,5],[3,4],[3,5],[3],[4,5],[4],[5],[]]</code></pre>
<p>That was a bit harder than necessary!</p>
<h2 id="either">Either</h2>
<p>Using <strong>filterM</strong> with <strong>Either</strong> is pretty much the same as a <strong>Maybe</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="kw">let</span> e1 <span class="fu">=</span> filterM (\x <span class="ot">-&gt;</span> <span class="kw">if</span> x <span class="fu">==</span> <span class="dv">11</span> <span class="kw">then</span> <span class="dt">Left</span> <span class="st">&quot;You gave me eleven&quot;</span> <span class="kw">else</span> <span class="dt">Right</span> (isEven x))
<span class="co">-- e1 :: :: Integral a =&gt; [a] -&gt; Either [Char] [a]</span>
e1 [<span class="dv">1</span> <span class="fu">..</span> <span class="dv">10</span>]
<span class="fu">=</span> <span class="dt">Right</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>] <span class="co">-- only even numbers</span>
e1 [<span class="dv">1</span> <span class="fu">..</span> <span class="dv">11</span>]
<span class="fu">=</span> <span class="dt">Left</span> <span class="st">&quot;You gave me eleven&quot;</span> <span class="co">-- drops all results on a Left</span></code></pre></div>
<h2 id="state">State</h2>
<p>Now let’s use a Monad that has two type holes which are both used together. The State Monad allows us to return a value and thread through some state we are interested in at the same time. Let’s use our <strong>isEven</strong> method to filter in all the even inputs and use a list to record all the values inspected along the way:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="kw">let</span> x1 <span class="fu">=</span> filterM (\x <span class="ot">-&gt;</span> state (\s <span class="ot">-&gt;</span> (isEven(x), s <span class="fu">++</span> [x]))) [<span class="dv">1</span> <span class="fu">..</span> <span class="dv">10</span>]
<span class="co">-- x1 :: (Integral a, Monad m) =&gt; StateT [a] m [a]</span>
evalState x1 []          <span class="co">-- get value</span>
<span class="fu">=</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>]           <span class="co">-- only even numbers</span>
execState x1 []          <span class="co">-- get state</span>
<span class="fu">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>] <span class="co">-- the state - all inspected values</span></code></pre></div>
<p>The interesting thing to note is that given <strong>x1</strong>’s type:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">x1 ::</span> (<span class="dt">Integral</span> a, <span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">StateT</span> [a] m [a]</code></pre></div>
<p>The <strong>m</strong> in <strong>filterM</strong>:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="ot">filterM ::</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> m [a]</code></pre></div>
<p>is:</p>
<div class="sourceCode"><pre class="sourceCode haskell scrollx"><code class="sourceCode haskell"><span class="dt">StateT</span> [a] m</code></pre></div>
<p>which is why we can return a Bool in the value position and have it filter the inputs for us.</p>
<p>Hopefully that was somewhat easier to understand. You can find alternate explanations to this problem <a href="https://stackoverflow.com/questions/25476248/powerset-function-1-liner#45105085">here</a> and <a href="https://byorgey.wordpress.com/2007/06/26/deducing-code-from-types-filterm">here</a>.</p>]]></description>
    <pubDate>Tue, 10 Apr 2018 00:00:00 UT</pubDate>
    <guid>http://blog.ssanj.net/posts/2018-04-10-how-does-filterm-work-in-haskell.html</guid>
    <dc:creator>sanjiv sahayam</dc:creator>
</item>

    </channel>
</rss>
