<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Reading Configuration with Kleisli Arrows</title>
    <meta name="viewport" content="width=device-width">
    
    <meta name="description" content="How to use Kleisli Arrows supply an environment to a Monadic context similar to the Reader and ReaderT Monads.">
    
    <link rel="canonical" href="https://blog.ssanj.net/posts/2017-06-12-reading-configuration-with-kleisli-arrows.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main-2024-05-08.css">
    <link rel="stylesheet" type="text/css" href="../css/example-2024-05-05.css">
    <link rel="stylesheet" href="../css/syntax-2024-05-05.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    
  </head>

    <body>
      
          <div class="page-content">
      <div class="wrap">
        <div class="post">
          <header class="post-header">
            <h1><a href="../">Reading Configuration with Kleisli Arrows</a></h1>
            <p class="meta">June 12, 2017&nbsp;<span class="post-tag"><a title="All pages tagged 'arrow'." href="../tags/arrow.html">arrow</a>, <a title="All pages tagged 'fp'." href="../tags/fp.html">fp</a>, <a title="All pages tagged 'kleisli'." href="../tags/kleisli.html">kleisli</a>, <a title="All pages tagged 'scala'." href="../tags/scala.html">scala</a></span></p>
          </header>
          <article class="post-content">
            <p>In a <a href="http://sanj.ink/posts/2017-06-07-composing-monadic-functions-with-kleisli-arrows.html">previous article</a> we looked at how Kleisli Arrows compose functions in a Monadic context.</p>
<p>A Kleisli Arrow is defined as follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Kleisli<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">,</span> B<span class="op">](</span>run<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">])</span></span></code></pre></div>
<figure>
<img src="../images/kleisli-composition/kleisli-type.jpg" alt="Kleisli Arrow" />
<figcaption aria-hidden="true">Kleisli Arrow</figcaption>
</figure>
<p>In essence it wraps a function:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]</span></span></code></pre></div>
<p>Given some <em>A</em>, it returns a result <em>B</em> in a context F.</p>
<h3 id="reader-and-readert">Reader and ReaderT</h3>
<p>If we look at the signature of the Reader Monad, we see it wraps a somewhat similar function:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=&gt;</span> B</span></code></pre></div>
<figure>
<img src="../images/kleisli-config/reader.jpg" alt="Reader" />
<figcaption aria-hidden="true">Reader</figcaption>
</figure>
<p>Given some <em>A</em>, it returns a <em>B</em> without any context.</p>
<p>A <a href="http://hackage.haskell.org/package/mtl-2.2.1/docs/Control-Monad-Reader.html#v:ReaderT">ReaderT Monad Transformer</a> wraps the same function as that of a Kleisli Arrow:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ReaderT<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">,</span> B<span class="op">](</span>A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">])</span></span></code></pre></div>
<figure>
<img src="../images/kleisli-config/readert-type.jpg" alt="ReaderT" />
<figcaption aria-hidden="true">ReaderT</figcaption>
</figure>
<p>Given some A, it returns a B, in a context F.</p>
<p>A Kleisli Arrow has the same shape as (is isomorphic to) the ReaderT Monad. But what of its relationship to the Reader Monad?</p>
<p>An <strong>Id</strong> type constructor is a similar construct to the <strong>identity</strong> function, except that it returns the type supplied to it as opposed to the value:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Id<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A <span class="co">// returns the type supplied</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> identity<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span> value <span class="co">//returns the value supplied</span></span></code></pre></div>
<figure>
<img src="../images/kleisli-config/id-type.jpg" alt="Id" />
<figcaption aria-hidden="true">Id</figcaption>
</figure>
<p>Armed with the <strong>Id</strong> type constructor we can define the Reader Monad in terms of the ReaderT Monad (and the Kleisli Arrow):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ReaderT<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">,</span> B<span class="op">]</span>  <span class="op">==</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ReaderT<span class="op">[</span>Id<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span>    <span class="op">==</span> <span class="co">//specialising for Id</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ReaderT</span><span class="op">(</span>A <span class="op">=&gt;</span> Id<span class="op">[</span>B<span class="op">])</span>  <span class="op">==</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Reader</span><span class="op">(</span>A <span class="op">=&gt;</span> B<span class="op">)</span>       <span class="op">==</span> <span class="co">//since Id[B] == B</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Kleisli</span><span class="op">(</span>A <span class="op">=&gt;</span> B<span class="op">)</span>         <span class="co">//since ReaderT == Kleisli</span></span></code></pre></div>
<p>In <a href="http://typelevel.org/cats">Cats</a> both the Reader and ReaderT Monads are defined in terms of a Kliesli Arrow:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Reader</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span>        <span class="op">=</span> Kleisli<span class="op">[</span>Id<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ReaderT<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span>F<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span></code></pre></div>
<h3 id="using-kleisli-arrows-as-a-readert">Using Kleisli Arrows as a ReaderT</h3>
<p>Lets try and use a Kleisli Arrow to read some configuration from the environment to yield something useful. In the following example we want to create a <strong>Person</strong> object from a <strong>Name</strong> and <strong>Age</strong> obtained from a <strong>Config</strong> object that holds both values:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Name</span><span class="op">(</span>first<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> last<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Age</span><span class="op">(</span>age<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Person</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">Name</span><span class="op">,</span> age<span class="op">:</span> Age<span class="op">)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Config</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span></span></code></pre></div>
<p>The creation of <strong>Name</strong> and <strong>Age</strong> have rules surrounding them and can fail if the rules are not met:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readName<span class="op">:</span> Config <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> c <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> parts <span class="op">=</span> c<span class="op">.</span>name<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>parts<span class="op">.</span>length <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="ex">Option</span><span class="op">(</span><span class="ex">Name</span><span class="op">(</span><span class="fu">parts</span><span class="op">(</span><span class="dv">0</span><span class="op">),</span> parts<span class="op">.</span><span class="fu">drop</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">)))</span> <span class="cf">else</span> <span class="bu">None</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readNameK <span class="op">=</span> <span class="fu">Kleisli</span><span class="op">(</span>readName<span class="op">)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readAge<span class="op">:</span> Config <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span>Age<span class="op">]</span> <span class="op">=</span> c <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> age <span class="op">=</span> c<span class="op">.</span>age</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>age <span class="op">&gt;=</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> age <span class="op">&lt;=</span> <span class="dv">150</span><span class="op">)</span> <span class="ex">Option</span><span class="op">(</span><span class="fu">Age</span><span class="op">(</span>age<span class="op">))</span> <span class="cf">else</span> <span class="bu">None</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readAgeK <span class="op">=</span> <span class="fu">Kleisli</span><span class="op">(</span>readAge<span class="op">)</span></span></code></pre></div>
<p><strong>readNameK</strong> and <strong>readAgeK</strong> require a <strong>Config</strong> object to retrieve their values and are wrapped in a Kleisli Arrow. The Kleisli Arrow has to supply the same <strong>Config</strong> object to both functions. This is distinctly different to Kleisli composition where the output from one function was fed into the next. In this instance there is no composition between the two functions.</p>
<p>How would we go about combining these functions?</p>
<p>Since Kleisli Arrows map over functions in a Monadic context:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Kleisli<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">,</span> B<span class="op">]</span> <span class="co">//F has a Monad instance</span></span></code></pre></div>
<p>we can use a for-comprehension to solve our problem:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personK<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> Config<span class="op">,</span> Person<span class="op">]</span> <span class="op">=</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    name <span class="op">&lt;-</span> readNameK</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    age  <span class="op">&lt;-</span> readAgeK</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="fu">Person</span><span class="op">(</span>name<span class="op">,</span> age<span class="op">)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">//Some(Person(Name(Bojack,Horseman),Age(42)))</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result1 <span class="op">=</span> <span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Bojack Horseman&quot;</span><span class="op">,</span> <span class="dv">42</span><span class="op">))</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">//None - Name is not space-separated</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result2 <span class="op">=</span> <span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Jake&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">))</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">//None - age is not between 1 and 150</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result3 <span class="op">=</span> <span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Fred Flintstone&quot;</span><span class="op">,</span> <span class="dv">50000</span><span class="op">))</span></span></code></pre></div>
<h3 id="using-applicatives-to-read-configuration">Using Applicatives to Read Configuration</h3>
<p>You might have noticed that the <strong>readAgeK</strong> function does not directly depend on the output of <strong>readNameK</strong>. This implies that we don’t have to use a Monad here (for-comprehesion) and can use something a little less powerful like <a href="https://github.com/typelevel/cats/blob/155f7f534993c30d6e757de990330ac796dad5da/core/src/main/scala/cats/Apply.scala#L11">Apply</a>. <em>The Apply typeclass is an Applicative without the <strong>pure</strong> function</em>. The Kleisli data type has an <a href="https://github.com/typelevel/cats/blob/155f7f534993c30d6e757de990330ac796dad5da/core/src/main/scala/cats/data/Kleisli.scala#L170">instance for Apply</a> with the following signature:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Apply<span class="op">[</span>Kleisli<span class="op">[</span>F<span class="op">,</span> A<span class="op">,</span> <span class="op">?]]</span></span></code></pre></div>
<p>Let’s have a go at rewriting the Monadic code snippet with an Apply instead. We can use the <a href="https://github.com/typelevel/cats/blob/155f7f534993c30d6e757de990330ac796dad5da/core/src/main/scala/cats/Apply.scala#L25"><strong>ap2</strong></a> function which has the following definition:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ap2<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> Z<span class="op">](</span>ff<span class="op">:</span> F<span class="op">[(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> Z<span class="op">])(</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> fb<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span>Z<span class="op">]</span></span></code></pre></div>
<p>Using <strong>ap2</strong> we can create a <strong>Person</strong> instance as follows:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Apply</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> KOptionConfig<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> Config<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> PersonFunc <span class="op">=</span> <span class="op">(</span><span class="ex">Name</span><span class="op">,</span> Age<span class="op">)</span> <span class="op">=&gt;</span> Person</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> config <span class="op">=</span> <span class="fu">Config</span><span class="op">(</span><span class="st">&quot;mr peanutbutter&quot;</span><span class="op">,</span> <span class="dv">30</span><span class="op">)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readNameKOC<span class="op">:</span> KOptionConfig<span class="op">[</span><span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> readNameK</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readAgeKOC<span class="op">:</span> KOptionConfig<span class="op">[</span>Age<span class="op">]</span> <span class="op">=</span> readAgeK</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personKOC<span class="op">:</span> KOptionConfig<span class="op">[</span>PersonFunc<span class="op">]</span> <span class="op">=</span> <span class="fu">Kleisli</span><span class="op">(</span> <span class="op">(</span>_<span class="op">:</span> Config<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">(</span><span class="fu">Person</span><span class="op">(</span>_<span class="op">,</span> _<span class="op">)))</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">//Kleisli[Option, Config, Person]</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personK <span class="op">=</span> Apply<span class="op">[</span>KOptionConfig<span class="op">].</span><span class="fu">ap2</span><span class="op">(</span>personKOC<span class="op">)(</span>readNameKOC<span class="op">,</span> readAgeKOC<span class="op">)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">//Some(Person(Name(mr,peanutbutter),Age(30)))</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span>config<span class="op">)</span></span></code></pre></div>
<p>This solution while “less powerful” than the Monadic version, is somewhat uglier in Scala due to the type ascriptions on the individual functions.</p>
<p>We can also do something very similar using the <a href="https://github.com/typelevel/cats/blob/155f7f534993c30d6e757de990330ac796dad5da/core/src/main/scala/cats/Apply.scala#L33"><strong>map2</strong></a> method:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map2<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> Z<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> fb<span class="op">:</span> F<span class="op">[</span>B<span class="op">])(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> Z<span class="op">):</span> F<span class="op">[</span>Z<span class="op">]</span></span></code></pre></div>
<p>which might be easier to reason about than <strong>ap2</strong>, but essentially they achieve the same result:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Apply</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> KOptionConfig<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> Config<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> config <span class="op">=</span> <span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Diane Nguyen&quot;</span><span class="op">,</span> <span class="dv">27</span><span class="op">)</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readNameKOC<span class="op">:</span> KOptionConfig<span class="op">[</span><span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> readNameK</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readAgeKOC<span class="op">:</span> KOptionConfig<span class="op">[</span>Age<span class="op">]</span> <span class="op">=</span> readAgeK</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">//Kleisli[Option, Config, Person]</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personK <span class="op">=</span> Apply<span class="op">[</span>KOptionConfig<span class="op">].</span><span class="fu">map2</span><span class="op">(</span>readNameKOC<span class="op">,</span> readAgeKOC<span class="op">)</span> <span class="op">{</span> <span class="fu">Person</span><span class="op">(</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">}</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">//Some(Person(Name(Diane,Nguyen),Age(27)))</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span>config<span class="op">)</span></span></code></pre></div>
<h3 id="kleisli-arrows-with-different-inputs">Kleisli Arrows with Different Inputs</h3>
<p>One thing to note is that we keep aligning the input type, <strong>Config</strong> in this case, through all Kleisli Arrows.</p>
<p>How would we go about combining Kleisli Arrows with different input types?</p>
<p>This is where the <a href="https://github.com/typelevel/cats/blob/155f7f534993c30d6e757de990330ac796dad5da/core/src/main/scala/cats/data/Kleisli.scala#L48"><strong>local</strong></a> function comes into play. It is defined as:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> local<span class="op">[</span>AA<span class="op">](</span>f<span class="op">:</span> AA <span class="op">=&gt;</span> A<span class="op">):</span> Kleisli<span class="op">[</span>F<span class="op">,</span> AA<span class="op">,</span> B<span class="op">]</span></span></code></pre></div>
<figure>
<img src="../images/kleisli-config/kleisli-local.jpg" alt="Local" />
<figcaption aria-hidden="true">Local</figcaption>
</figure>
<p>It basically converts a <code>Kleisli[F, A, B]</code> to a <code>Kleisli[F, AA, B]</code> as long as we supply it a function to convert an <em>AA</em> to <em>A</em>. The function <strong>f</strong> here converts some other input type <em>AA</em> into our required input type of <em>A</em>. This allows us to combine Kleisli Arrows with different input types as the <strong>local</strong> function, widens the input type to each Kleisli Arrow as <em>AA</em>.</p>
<p>Lets rewrite our previous example with Kleisli Arrows that take a <strong>String</strong> as input to <strong>readName</strong> and an <strong>Int</strong> as an input to <strong>readAge</strong> functions:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readName<span class="op">:</span> <span class="ex">String</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> name <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> parts <span class="op">=</span> name<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>parts<span class="op">.</span>length <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="ex">Option</span><span class="op">(</span><span class="ex">Name</span><span class="op">(</span><span class="fu">parts</span><span class="op">(</span><span class="dv">0</span><span class="op">),</span> parts<span class="op">.</span><span class="fu">drop</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">)))</span> <span class="cf">else</span> <span class="bu">None</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readAge<span class="op">:</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span>Age<span class="op">]</span> <span class="op">=</span> age <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>age <span class="op">&gt;=</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> age <span class="op">&lt;=</span> <span class="dv">150</span><span class="op">)</span> <span class="ex">Option</span><span class="op">(</span><span class="fu">Age</span><span class="op">(</span>age<span class="op">))</span> <span class="cf">else</span> <span class="bu">None</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readNameK<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Kleisli</span><span class="op">(</span>readName<span class="op">)</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> readAgeK<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> Age<span class="op">]</span> <span class="op">=</span> <span class="fu">Kleisli</span><span class="op">(</span>readAge<span class="op">)</span></span></code></pre></div>
<p>We then widen the input types with the <strong>local</strong> function that takes a <strong>Config</strong> object:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personK<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> Config<span class="op">,</span> Person<span class="op">]</span> <span class="op">=</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    name <span class="op">&lt;-</span> readNameK<span class="op">.</span>local<span class="op">[</span>Config<span class="op">](</span>_<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    age  <span class="op">&lt;-</span> readAgeK<span class="op">.</span>local<span class="op">[</span>Config<span class="op">](</span>_<span class="op">.</span>age<span class="op">)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="fu">Person</span><span class="op">(</span>name<span class="op">,</span> age<span class="op">)</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">//Some(Person(Name(Bojack,Horseman),Age(42)))</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Bojack Horseman&quot;</span><span class="op">,</span> <span class="dv">42</span><span class="op">))</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">//None</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Jake&quot;</span><span class="op">,</span> <span class="dv">20</span><span class="op">))</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">//None</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Fred Flintstone&quot;</span><span class="op">,</span> <span class="dv">50000</span><span class="op">))</span></span></code></pre></div>
<p>And using <strong>map2</strong> we get the same results:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode scala scrollx"><code class="sourceCode scala"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Apply</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> KOptionConfig<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> Config<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> config <span class="op">=</span> <span class="fu">Config</span><span class="op">(</span><span class="st">&quot;Diane Nguyen&quot;</span><span class="op">,</span> <span class="dv">27</span><span class="op">)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readNameKOC<span class="op">:</span> KOptionConfig<span class="op">[</span><span class="ex">Name</span><span class="op">]</span> <span class="op">=</span> readNameK<span class="op">.</span>local<span class="op">[</span>Config<span class="op">](</span>_<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> readAgeKOC<span class="op">:</span> KOptionConfig<span class="op">[</span>Age<span class="op">]</span> <span class="op">=</span> readAgeK<span class="op">.</span>local<span class="op">[</span>Config<span class="op">](</span>_<span class="op">.</span>age<span class="op">)</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> personK <span class="op">=</span> Apply<span class="op">[</span>KOptionConfig<span class="op">].</span><span class="fu">map2</span><span class="op">(</span>readNameKOC<span class="op">,</span> readAgeKOC<span class="op">)</span> <span class="op">{</span> <span class="fu">Person</span><span class="op">(</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">}</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">//Some(Person(Name(Diane,Nguyen),Age(27)))</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">personK</span><span class="op">(</span>config<span class="op">)</span></span></code></pre></div>
          </article>
        </div>
        
          <div id="disqus_thread"></div>
          <script>
              /**
              *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
              *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */

              var disqus_config = function () {
              this.page.url = 'https://ssanj.github.io' + '/posts/2017-06-12-reading-configuration-with-kleisli-arrows.html';
              this.page.identifier = '/posts/2017-06-12-reading-configuration-with-kleisli-arrows.html';
              };

              (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://babyloncandle.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
    </div>


      
    </body>
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/typeahead.bundle.min.js"></script>
    <script src="../js/handlebars-v1.3.0.js"></script>
    <script src="../js/babyloncandle.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55156872-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55156872-1');
    </script>
</html>
